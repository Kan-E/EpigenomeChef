---
title: "Pair-wise analysis with EpigenomeChef v1.0.4-beta"
date: '`r format(Sys.time(), "%y/%m/%d %H:%M")`'
params:
    raw_count: [some object]
    input: [some object]
    collist_bw_pair: [some object]
    norm_count: [some object]
    deg_norm_count: [some object]
    input_list_data_pair: [some object]
    enrichment_1_1: [some object]
    region_gene_associate: [some object]
    enrich_motif: [some object]
    base_dir: [some object]
    RNAseqDEG: [some object]
    dirname_withRNA: [some object]
    RP_all_table: [some object]
    int_goi_promoter_position: [some object]
    int_goi_gene_position: [some object]
    gene: [some object]
    int_enrich_table: [some object]
    integrated_heatlist: [some object]
    RNAseq_file: [some object]
    with_integrated_heatlist_plot: [some object]
output:
  word_document
fontsize: 10pt
---

## Parameters
 - Uploaded file name:
```{r echo = FALSE}
try(knitr::kable(params$input_list_data_pair))
```

 - Experimental condition: 
 **`r unique(gsub("\\_.+$", "", colnames(params$deg_norm_count)))[1]` vs `r unique(gsub("\\_.+$", "", colnames(params$deg_norm_count)))[2]`**
 - Filter condition: 
 **`r params$input$pair_filter`**
 - Species: 
 **`r params$input$Species`**
 - Cut-off condition: 
 FoldChange = **`r params$input$fc`**, FDR = **`r params$input$fdr`**, 
 Basemean = **`r params$input$basemean`**
 - tested count data
```{r echo = FALSE}
try(knitr::kable(head(params$deg_norm_count)))
```

\newpage

## Result overview
 - Clustering (PCA, MDS, dendrogram (ward.D2)) (Clustering/pca.pdf)
```{r, out.width="0.3\\linewidth", include=TRUE, fig.align="center", echo=FALSE}
try(magick::image_read_pdf("./Clustering/clustering.pdf"))
```
 - PCA_table (Clustering/pca.txt)

 - Volcano plot (DAR_result/volcano_plot.pdf)
```{r, out.width="0.3\\linewidth", include=TRUE, fig.align="center", echo=FALSE}
if(!is.null(params$input$xrange)){
try(magick::image_read_pdf("./DAR_result/volcano_plot.pdf"))
}else print("No plot")
```
 
 - Result table (DAR_result/DAR_result.txt)
 - Up DAR (DAR_result/up.bed)
 - Down DAR (DAR_result/down.bed)
\newpage

## Peak distribution
 - Annotation of `r params$collist_bw_pair[2]`_high peaks (peak_distribution/`r params$collist_bw_pair[2]`_high_annotation.pdf)
```{r, out.width="0.3\\linewidth", include=TRUE, fig.align="center", echo=FALSE}
if(params$input$Species != "not selected"){
          if(params$input$Genomic_region == "Genome-wide"){
try(magick::image_read_pdf(paste0("./peak_distribution/",unique(params$collist_bw_pair)[2],"_high_annotation.pdf")))
          }}else print("No plot")
```

 - Annotation of `r params$collist_bw_pair[1]`_high peaks (peak_distribution/`r params$collist_bw_pair[1]`_high_annotation.pdf)
```{r, out.width="0.3\\linewidth", include=TRUE, fig.align="center", echo=FALSE}
if(params$input$Species != "not selected"){
          if(params$input$Genomic_region == "Genome-wide"){
try(magick::image_read_pdf(paste0("./peak_distribution/",unique(params$collist_bw_pair)[1],"_high_annotation.pdf")))
          }}else print("No plot")
```

・Gene level

Promoter = 2000 bp upstream to 100 bp downstream of the transcription start site (TSS)

Downstream = Up to 1000 bp downstream of the gene (not downstream of the ORF, but downstream of the transcription end site, TES)

Gene body = Transcribed region excluding the promoter and downstream regions (including introns)

Distal intergenic = Genomic regions not included in the promoter, downstream, or gene body regions

・Exon/Intron/Intergenic level (intermediate pie chart)

Exon = Exonic regions

Intron = Intronic regions

Intergenic = Regions outside of exons and introns

・Exon level

CDS = Coding sequence

5’UTR = Upstream region of exons, preceding the CDS

3’UTR = Downstream region of exons, following the CDS

Other exon = Regions that are classified as exons but do not correspond to CDS, 5’UTR, or 3’UTR based on TxDb (annotation 
information), including single exon transcripts such as "short noncoding."

\newpage

## Peak pattern

 - Peak pattern of `r params$collist_bw_pair[2]`_high peaks (line plot: peak_pattern/`r params$collist_bw_pair[2]`_high_lineplot.pdf, heatmap: peak_pattern/`r params$collist_bw_pair[2]`_high_heatmap.pdf)
 
```{r, out.height=255.68181, out.width=255.68181, include=TRUE, fig.align="center", echo=FALSE}
if(!is.null(params$input$peak_up_range)){
  heatmap <- magick::image_read_pdf(paste0("./peak_pattern/",unique(params$collist_bw_pair)[2],"_high_heatmap.pdf"))
  heatmap
          }else print("No plot")
```
```{r, out.height=255.68181, out.width=255.68181, include=TRUE, fig.align="center", echo=FALSE}
if(!is.null(params$input$peak_up_range)){
  line <- magick::image_read_pdf(paste0("./peak_pattern/",unique(params$collist_bw_pair)[2],"_high_lineplot.pdf"))
  line
          }else print("No plot")
```
 
 - Peak pattern of `r params$collist_bw_pair[1]`_high peaks (line plot: peak_pattern/`r params$collist_bw_pair[1]`_high_lineplot.pdf, heatmap: peak_pattern/`r params$collist_bw_pair[1]`_high_heatmap.pdf)
 
```{r, out.height=255.68181, out.width=255.68181, include=TRUE, fig.align="center", echo=FALSE}
if(!is.null(params$input$peak_down_range)){
  heatmap <- magick::image_read_pdf(paste0("./peak_pattern/",unique(params$collist_bw_pair)[1],"_high_heatmap.pdf"))
  heatmap
          }else print("No plot")
```
```{r, out.height=255.68181, out.width=255.68181, include=TRUE, fig.align="center", echo=FALSE}
if(!is.null(params$input$peak_down_range)){
  line <- magick::image_read_pdf(paste0("./peak_pattern/",unique(params$collist_bw_pair)[1],"_high_lineplot.pdf"))
  line
          }else print("No plot")
```

\newpage

## GREAT

 - Gene set: `r params$input$Gene_set`
 - Dotplot (GREAT/dotplot_`r params$input$Gene_set`.pdf)
 
```{r, out.height=255.68181, out.width=306.818172, include=TRUE, fig.align="center", echo=FALSE}
if(params$input$Species != "not selected" && !is.null(params$input$Gene_set) && params$input$Genomic_region == "Genome-wide"){
try(magick::image_read_pdf(paste0("GREAT/dotplot_",params$input$Gene_set,".pdf")))
          }else print("No plot")
```

 - table data (GREAT/enrichment_`r params$input$Gene_set`.txt)
 
```{r echo = FALSE}
try(knitr::kable(as.data.frame(params$enrichment_1_1),row.names=FALSE))
```

 - Pathway_list: `r params$input$Pathway_list`
 - Which_group: `r params$input$Up_or_Down`
 - region associate plot (GREAT/"`r params$input$Gene_set`_`r params$input$Pathway_list`_`r params$input$Up_or_Down`.pdf)
 
```{r, out.height=255.68181, out.width=613.636344, include=TRUE, fig.align="center", echo=FALSE}
if(params$input$Species != "not selected" && !is.null(params$input$Gene_set) && params$input$Genomic_region == "Genome-wide"){
try(magick::image_read_pdf(paste0("GREAT/",params$input$Gene_set,"_",params$input$Pathway_list,"_",params$input$Up_or_Down,".pdf")))
          }else print("No plot")
```

 - table data (GREAT/"`r params$input$Gene_set`_`r params$input$Pathway_list`_`r params$input$Up_or_Down`.txt)
 
```{r echo = FALSE}
if(params$input$Species != "not selected" && !is.null(params$input$Gene_set) && params$input$Genomic_region == "Genome-wide"){
table <- try(as.data.frame(params$region_gene_associate))
table$Group <- try(gsub("\n","",table$Group))
try(knitr::kable(table))
}
```
 
\newpage

## HOMER

 - Type of enrichment analysis: `r params$input$homer_unknown`
 - Type of the region for motif finding: `r params$input$homer_size`
 - Size of the region for motif finding: `r params$input$homer_size2`
 - Background sequence: `r params$input$homer_bg`
 - Dotplot (`r params$base_dir`/homer_dotplot.pdf)
 
```{r, out.height=306.818172, out.width=357.954534, include=TRUE, fig.align="center", echo=FALSE}
if(params$input$motifButton > 0 && !is.null(params$enrich_motif) && 
             !is.null(params$input$homer_unknown)){
magick::image_read_pdf(paste0(params$base_dir,"/homer_dotplot",".pdf"))
          }else print("No plot")
```

- known motif of `r params$collist_bw_pair[2]`_high peak (`r params$base_dir`/`r params$collist_bw_pair[1]`_high/knownResults.html)

```{r echo=FALSE}
if(params$input$motifButton > 0 && !is.null(params$enrich_motif) && 
             !is.null(params$input$homer_unknown)){
  try(print(paste0(params$enrich_motif[[1]],"/knownResults.html")))
try(webshot(paste0("./",params$enrich_motif[[1]],"/knownResults.html"),file="img1.png"))
          }else print("Not performed")
```

- known motif of `r params$collist_bw_pair[1]`_high peak (`r params$base_dir`/`r params$collist_bw_pair[1]`_high/knownResults.html)

```{r echo=FALSE}
if(params$input$motifButton > 0 && !is.null(params$enrich_motif) && 
             !is.null(params$input$homer_unknown)){
try(webshot(paste0("./",params$enrich_motif[[2]],"/knownResults.html"),file="img2.png"))
          }else print("Not performed")
```

- unknown motif of `r params$collist_bw_pair[2]`_high peak (`r params$base_dir`/`r params$collist_bw_pair[2]`_high/homerResults.html)

```{r echo=FALSE}
if(params$input$motifButton > 0 && !is.null(params$enrich_motif) && 
             params$input$homer_unknown == "known and de novo motifs"){
try(webshot(paste0("./",params$enrich_motif[[1]],"/homerResults.html"),file="img3.png"))
          }else print("Not performed")
```

- unknown motif of `r params$collist_bw_pair[1]`_high peak (`r params$base_dir`/`r params$collist_bw_pair[1]`_high/homerResults.html)

```{r echo=FALSE}
if(params$input$motifButton > 0 && !is.null(params$enrich_motif) && 
             params$input$homer_unknown == "known and de novo motifs"){
try(webshot(paste0("./",params$enrich_motif[[2]],"/homerResults.html"),file="img4.png"))
          }else print("Not performed")
```
 
  
\newpage

## Combined heatmap

```{r, out.width="0.3\\linewidth", include=TRUE, fig.align="center", fig.cap=c(""), echo=FALSE}
if(params$input$Species != "not selected" && params$input$integrated_heatmapButton > 0 && 
   !is.null(params$integrated_heatlist)){
try(magick::image_read_pdf(paste0("combined_heatmap/","combined_heatmap.pdf")))
}else print("Not performed")
```

 
\newpage

## withRNAseq

 - Type of RNA-seq data: **`r params$input$RNAseq_data_type`**

 - Uploaded RNAseq DEG result (file: `r params$input$pair_DEG_result$name`)
 
```{r echo = FALSE}
if(params$input$Species != "not selected" && !is.null(params$input$peak_distance) && !is.null(params$RNAseqDEG) && !is.na(params$input$DEG_fdr) && 
   !is.na(params$input$DEG_fc)){
try(knitr::kable(head(params$RNAseqDEG)))
}
```
```{r echo = FALSE}
if(params$input$Species != "not selected" && !is.null(params$input$peak_distance) && !is.null(params$RNAseqDEG) && !is.na(params$input$DEG_fdr) && 
   !is.na(params$input$DEG_fc)){
      if(params$input$RNAseq_data_type != "Result"){
    if(!is.null(params$RNAseq_file)){
      try(knitr::kable(head(params$RNAseq_file)))
    }
    }
}
```
```{r echo = FALSE}
if(params$input$Species != "not selected" && !is.null(params$input$peak_distance) && !is.null(params$RNAseqDEG) && !is.na(params$input$DEG_fdr) && 
   !is.na(params$input$DEG_fc)){
      if(params$input$RNAseq_data_type == "Result"){
    if(!is.null(params$RNAseq_file)){
      paste0(params$input$RNAseq_cond1_pair, " vs ", params$input$RNAseq_cond2_pair, "\n",
           "Please confirm if the Log2FoldChange in the uploaded result file was calulated as Log2(",params$input$RNAseq_cond1_pair,"/",params$input$RNAseq_cond2_pair,").")
    }
    }
}
```

`r paste0("Epigenome analysis: ",unique(params$collist_bw_pair)[1], " vs ", unique(params$collist_bw_pair)[2], "\n",
             "RP > 0 genes have a higher epigenetic potential in ", unique(params$collist_bw_pair)[2]," condition.\n",
             "RP < 0 genes have a higher epigenetic potential in ", unique(params$collist_bw_pair)[1]," condition.\n",
             "RP = 0 genes have no significant difference in epigenetic potential between ", unique(params$collist_bw_pair)[1], " and ", unique(params$collist_bw_pair)[2]," conditions.")`

- Mode: `r params$input$RNAseq_mode`

```{r echo = FALSE, results='asis'}
if(params$input$RNAseq_mode == "Gene_scan") {
  try(cat(paste0("range: **", params$input$peak_distance,"** kb\n\n")))
}
```

 - Parameters: FoldChange = `r params$input$DEG_fc`, FDR = `r params$input$DEG_fdr`
 
  - Boxplot (`r params$dirname_withRNA`boxplot.pdf)
  
```{r, out.height=255.68181, out.width=357.954534, include=TRUE, fig.align="center", echo=FALSE}
if(params$input$Species != "not selected" && !is.null(params$RNAseqDEG) && 
   !is.na(params$input$DEG_fdr) && !is.na(params$input$DEG_fc)){
 path = paste0("./",params$dirname_withRNA,"boxplot.pdf")
 try(magick::image_read_pdf(path,density = 300))
          }else print("Not performed")
```

 - KS plot and barplot (`r params$dirname_withRNA`/KSplot.pdf and barplot.pdf)
 
```{r, out.width="0.3\\linewidth", include=TRUE, fig.align="center", echo=FALSE}
if(params$input$Species != "not selected" &&  !is.null(params$RNAseqDEG) && !is.na(params$input$DEG_fdr) && 
   !is.na(params$input$DEG_fc)){
    try(magick::image_read_pdf(paste0("./",params$dirname_withRNA,"barplot.pdf")))
          }else print("Not performed")
```
```{r, out.width="0.3\\linewidth", include=TRUE, fig.align="center", echo=FALSE}
if(params$input$Species != "not selected" &&  !is.null(params$RNAseqDEG) && 
   !is.na(params$input$DEG_fdr) && !is.na(params$input$DEG_fc)){
    try(magick::image_read_pdf(paste0("./",params$dirname_withRNA,"KSplot.pdf")))
          }else print("Not performed")
```


 - summary table (paste0(dirname_withRNA,"RP_summary.txt"))
 
```{r echo = FALSE}
if(params$input$Species != "not selected" && !is.null(params$input$peak_distance) && !is.null(params$RNAseqDEG) && !is.na(params$input$DEG_fdr) && 
   !is.na(params$input$DEG_fc)){
try(knitr::kable(head(params$RP_all_table)))
}
```
 
 - Selected table (.bed) (`r params$dirname_withRNA`/selected_bed(epigenome:RNA)/)
 - Selected table (.txt) (`r params$dirname_withRNA`/selected_table(epigenome:RNA)/)

```{r, out.width="0.3\\linewidth", include=TRUE, fig.align="center", echo=FALSE}
if(params$input$Species != "not selected" && !is.null(params$input$peak_distance) && !is.null(params$RNAseqDEG) && !is.na(params$input$DEG_fdr) && 
   !is.na(params$input$DEG_fc) && !is.null(params$input$RP_table_rows_selected) && 
   !is.null(params$int_goi_promoter_position) && !is.null(params$int_goi_gene_position) &&
   !is.null(params$input$int_igv_uprange)){
  print(paste0("Trackplot of ", params$gene, " (",paste0(params$dirname_withRNA,params$gene,".pdf"),")"))
  try(magick::image_read_pdf(paste0("./",params$dirname_withRNA,params$gene,".pdf"),density = 300))
          }else print("Trackplot: Not performed")
```

 - Enrichment analysis: Gene set: `r params$input$intGeneset`, tested groups: `r params$input$intGroup` `r paste0(params$dirname_withRNA,"enrichment_analysis/dotplot_",params$input$intGeneset,".pdf")`
 - Dotplot (`r paste0(params$dirname_withRNA,"enrichment_analysis/dotplot_",params$input$intGeneset,".pdf")`)
```{r, out.height=255.68181, out.width=409.090896, include=TRUE, fig.align="center", fig.cap=c(""), echo=FALSE}
if(params$input$Species != "not selected" && !is.null(params$input$peak_distance) && !is.null(params$RNAseqDEG) && !is.na(params$input$DEG_fdr) && 
   !is.na(params$input$DEG_fc) && !is.null(params$input$intGeneset) && !is.null(params$input$intGroup)){
try(magick::image_read_pdf(paste0(params$dirname_withRNA,"enrichment_analysis/dotplot_",params$input$intGeneset,".pdf")))
}
```

 - Table data (`r paste0(params$dirname_withRNA,"enrichment_analysis/enrichment_",params$input$intGeneset,".txt")`)
```{r echo = FALSE}
if(params$input$Species != "not selected" && !is.null(params$input$peak_distance) && !is.null(params$RNAseqDEG) && !is.na(params$input$DEG_fdr) && 
   !is.na(params$input$DEG_fc)){
table <- try(params$int_enrich_table[,-3:-6])
table$Group <- try(gsub("\n","",table$Group))
try(knitr::kable(table, escape = F))
}
```
 
 - Combined heatmap (`r paste0(params$dirname_withRNA,"combined_heatmap/combined_heatmap.pdf")`)
```{r echo = FALSE}
if(params$input$Species != "not selected" && !is.null(params$RNAseqDEG) && !is.na(params$input$DEG_fdr) && 
   !is.na(params$input$DEG_fc) && !is.null(params$input$Group_integrated_heatmap)){
try(magick::image_read_pdf(paste0(params$dirname_withRNA,"combined_heatmap/combined_heatmap.pdf")))
}
```
